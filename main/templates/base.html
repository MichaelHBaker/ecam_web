{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <!-- W3.CSS CSS -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!-- bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css">

    <link rel="stylesheet" href="{% static 'main/css/main.css' %}">
    <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}">
    
    {% block extra_css %}
    {% endblock %}
</head>
<body>
    <header class="w3-container">
        <h5 class="w3-center">Energy Charting and Metrics (ECAM web version)</h5>
    </header>

    <nav id="Base-nav-id" class="w3-bar">
        <a href="{% url 'dashboard' %}" class="w3-bar-item w3-button" data-action="navigate">Home</a>
        <a href="#" class="w3-bar-item w3-button" data-action="navigate">About</a>
        <a href="#" class="w3-bar-item w3-button" data-action="navigate">Contact</a>
    </nav>

    <div class="w3-container" style="margin-top:20px">
        {% block content %}
        <!-- Main content goes here -->
        {% endblock %}
    </div>

    <footer class="w3-container">
        <h5>Footer</h5>
        <p>Copyright Â© {{ year }}</p>
    </footer>
    
    {% block extra_js %}

    <script type="module">
    // First import State as other modules depend on it
    import { State } from '/static/main/js/state.js';

    // Import core utilities
    import { DOM } from '/static/main/js/dom.js';           // DOM manipulation
    import { Events } from '/static/main/js/events.js';     // Event handling
    import { API } from '/static/main/js/api.js';          // API communication

    // Import UI managers
    import { 
        NotificationUI, 
        StatusUI, 
        TreeUI 
    } from '/static/main/js/ui.js';                       // UI components

    // Import additional managers
    import { Modal } from '/static/main/js/modals.js';     // Modal windows
    import { Forms } from '/static/main/js/forms.js';      // Form handling
    import { CRUD } from '/static/main/js/crud.js';        // Data operations

    /**
    * Core initialization function
    * Handles initializing all managers in the correct order
    */
    async function initializeCore() {
        try {
            // Set initial application state
            State.set('app_state', {
                initialized: false,
                lastUpdate: new Date(),
                currentPage: window.location.pathname
            });

            // First Layer: Core Utilities
            // These provide fundamental functionality other modules depend on
            await DOM.initialize();    // Initialize DOM utilities first
            await API.initialize();    // Then API services
            await Events.initialize(); // Then event handling

            // Second Layer: UI Managers
            // These provide user interface functionality
            await NotificationUI.initialize();  // Notifications
            await StatusUI.initialize();        // Status messages
            await Modal.initialize();           // Modal windows

            // Third Layer: Business Logic Managers
            // These handle application-specific operations
            await Forms.initialize();  // Form handling
            await CRUD.initialize();   // Data operations
            await TreeUI.initialize(); // Tree structure UI

            // Update application state to reflect successful initialization
            State.update('app_state', {
                initialized: true,
                lastUpdate: new Date()
            });

            // Dispatch event for page-specific code to know core is ready
            window.dispatchEvent(new CustomEvent('core:initialized'));

        } catch (error) {
            // Log error for debugging
            console.error('Core initialization failed:', error);

            // Show user-friendly error message
            NotificationUI.show({
                message: `Initialization failed: ${error.message}`,
                type: 'error',
                duration: 5000
            });
        }
    }

    // Wait for DOM to be ready before initializing
    // This ensures all HTML elements exist before we try to interact with them
    document.addEventListener('DOMContentLoaded', initializeCore);

    // Global error handler for uncaught errors
    window.addEventListener('error', (event) => {
        // Show user-friendly error message for any uncaught errors
        NotificationUI.show({
            message: `Error: ${event.message}`,
            type: 'error',
            duration: 5000
        });
    });

    // Optional: Handle unhandled promise rejections
    window.addEventListener('unhandledrejection', (event) => {
        NotificationUI.show({
            message: `Async Error: ${event.reason}`,
            type: 'error',
            duration: 5000
        });
    });

    // Optional: Log when initialization is complete
    window.addEventListener('core:initialized', () => {
        console.log('Core initialization complete:', new Date());
    });
    </script>
   
    {% endblock %}
</body>
</html>