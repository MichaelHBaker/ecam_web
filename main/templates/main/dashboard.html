{% extends 'base.html' %}

{% block title %}ECAM Web{% endblock %}

{% block extra_css %}
<style>
    .w3-dropdown-content {
        transform: translateX(-10%);
    }

    .tree-headings {
        padding-left: 35px;
    }
    .tree-heading-before {
        padding-left: 6px;
    }

    .caret::before {
        content: "\25B6";
        display: inline-block;
        margin-right: 6px;
    }

    .caret-down::before {
        transform: rotate(90deg);
    }

    .tree-item {
        display: flex; /* Align children in a row */
        align-items: center; /* Vertically center align */
        padding: 4px 0; /* Add some spacing */
    }

    .tree-item .tree-text {
        flex-grow: 1; /* Allow text to grow as needed */
    }

    .tree-item .item-actions {
        display: none; /* Hide by default */
        margin-left: 20px; /* Position 20px from the text */
        z-index: 1;
    }

    /* Show the three dots on hover */
    .tree-item:hover .item-actions {
        display: inline-block;
    }

    /* Dropdown appears when hovering on the three dots */
    .item-actions:hover .w3-dropdown-content {
        display: block;
    }

    /* Hover effect for tree items */
    .tree-item:hover {
        background-color: #f1f1f1;
    }

    .w3-container-tree {
        width: fit-content !important; /* Override the width */
    }

    /* Scoped to section buttons in the dashboard */
    .w3-bar-item.w3-button.section-button {
        width: 200px; /* Set a fixed width for section buttons */
        text-align: left; /* Align text to the left */
        padding-left: 16px; /* Optional padding */

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
            
    }
        
    
</style>
{% endblock %}

{% block content %}

<!-- Location Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('location')" class="w3-bar-item w3-button section-button">
        <i id="chevronIcon-location" class="bi bi-chevron-right"></i> Location
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'location' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportlocation()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="location" class="w3-container w3-container-tree w3-hide">
    <span class="tree-headings">
        Clients
        <i class="bi bi-chevron-right"></i><span class=tree-heading-before>Projects</span>
        <i class="bi bi-chevron-right"></i><span class=tree-heading-before>Locations</span>
        <i class="bi bi-chevron-right"></i><span class=tree-heading-before>Measurements</span>
    </span>

    {% for client in clients %}
    <div class="tree-item w3-hover-light-grey">
        <div class="tree-text">
            <button onclick="toggleOpenClose('{{ client.id }}')" class="w3-button" title="Email: {{ client.contact_email }}, Phone: {{ client.phone_number}}">
                <i id="chevronIcon-{{ client.id }}" class="bi bi-chevron-right"></i>
                <span id="clientName-{{ client.id }}">{{ client.name }}</span>
            </button>
        </div>
        {% if edit_client_id == client.id %}
        <div id="form-{{ client.id }}" style="display:block;">
            <form id="clientForm-{{ client.id }}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="client_id" value="{{ client.id }}">
                <input type="text" name="name" value="{{ client.name }}" required>
                <button type="submit" class="w3-button w3-green">Save</button>
            </form>
        </div>

        {% endif %}
        <div class="item-actions">
            <button class="w3-button">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <div class="w3-dropdown-content w3-bar-block w3-border">
                <a href="#" class="w3-bar-item w3-button"><i class="bi bi-plus"></i> Add Client</a>
                <a href="{% url 'dashboard' %}?edit={{ client.id }}" class="w3-bar-item w3-button"><i class="bi bi-pencil"></i> Edit</a>
                <a href="#" class="w3-bar-item w3-button"><i class="bi bi-trash"></i> Delete</a>
            </div>
        </div>
    </div>

    <div id="{{ client.name }}-{{ client.id }}" class="w3-container w3-hide w3-margin-left">
        {% for project in client.projects.all %}
        
        <div class="tree-item w3-hover-light-grey">
            <div class="tree-text">
                <button onclick="toggleOpenClose('{{ project.name }}-{{ project.id }}')" class="w3-button">
                    <i id="chevronIcon-{{ project.name }}-{{ project.id }}" class="bi bi-chevron-right"></i> {{ project.name }} ({{ project.get_project_type_display }})
                </button>
            </div>
            <div class="item-actions">
                <button class="w3-button">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <div class="w3-dropdown-content w3-bar-block w3-border">
                    <a href="#" class="w3-bar-item w3-button"><i class="bi bi-plus"></i> Add Project</a>
                    <a href="#" class="w3-bar-item w3-button"><i class="bi bi-pencil"></i> Edit</a>
                    <a href="#" class="w3-bar-item w3-button"><i class="bi bi-trash"></i> Delete</a>
                </div>
            </div>
        </div>
        
        
        <div id="{{ project.name }}-{{ project.id }}" class="w3-container w3-hide w3-margin-left">
            {% for location in project.locations.all %}
            <div class="tree-item w3-hover-light-grey">
                <div class="tree-text">
                    <button onclick="toggleOpenClose('{{ location.name }}-{{ location.id }}')" class="w3-button">
                        <i id="chevronIcon-{{ location.name }}-{{ location.id }}" class="bi bi-chevron-right"></i> {{ location.name }}
                    </button>
                </div>
                <div class="item-actions">
                    <button class="w3-button">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="w3-dropdown-content w3-bar-block w3-border">
                        <a href="#" class="w3-bar-item w3-button"><i class="bi bi-plus"></i> Add Location</a>
                        <a href="#" class="w3-bar-item w3-button"><i class="bi bi-pencil"></i> Edit</a>
                        <a href="#" class="w3-bar-item w3-button"><i class="bi bi-trash"></i> Delete</a>
                    </div>
                </div>
            </div>
            <div id="{{ location.name }}-{{ location.id }}" class="w3-container w3-hide w3-margin-left">
                {% for measurement in location.measurements.all %}
                <div class="tree-item w3-hover-light-grey">
                    <div class="tree-text">
                        <button class="w3-button">
                            {{ measurement.name }}
                        </button>
                    </div>
                    <div class="item-actions">
                        <button class="w3-button">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <div class="w3-dropdown-content w3-bar-block w3-border">
                            <a href="#" class="w3-bar-item w3-button"><i class="bi bi-plus"></i> Add Measurement</a>
                            <a href="#" class="w3-bar-item w3-button"><i class="bi bi-pencil"></i> Edit</a>
                            <a href="#" class="w3-bar-item w3-button"><i class="bi bi-trash"></i> Delete</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

{% comment %} <div id="editFormContainer"></div> {% endcomment %}

<!-- Measurement Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('measurement')" class="w3-bar-item w3-button section-button">
        <i id="chevronIcon-measurement" class="bi bi-chevron-right"></i> Measurement
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'measurement' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportmeasurement()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="measurement" class="w3-container w3-hide">
    <p>Content about Measurement.</p>
</div>

<!-- Data Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('data')" class="w3-bar-item w3-button section-button">
        <i id="chevronIcon-data" class="bi bi-chevron-right"></i> Data
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'data' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportdata()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="data" class="w3-container w3-hide">
    <p>Content about Data.</p>
</div>

<!-- Dictionary Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('dictionary')" class="w3-bar-item w3-button section-button">
        <i id="chevronIcon-dictionary" class="bi bi-chevron-right"></i> Dictionary
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'dictionary' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportdictionary()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="dictionary" class="w3-container w3-hide">
    <p>Content about Dictionary.</p>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function toggleOpenClose(id) {
        var div = document.getElementById(id);
        var icon = document.getElementById('chevronIcon-' + id);
        if (div.classList.contains('w3-show')) {
            div.classList.remove('w3-show');
            div.classList.add('w3-hide');
            icon.className = "bi bi-chevron-right";
        } else {
            div.classList.remove('w3-hide');
            div.classList.add('w3-show');
            icon.className = "bi bi-chevron-down";
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[id^="clientForm-"]').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();  // Prevent the default form submission
    
                var formId = this.getAttribute('id');
                var clientId = formId.split('-')[1];
                var formData = new FormData(this);
                var xhr = new XMLHttpRequest();  // Create a new XMLHttpRequest object
                xhr.open('POST', '{% url "update_client" %}');  // Set up the request
                xhr.setRequestHeader('X-CSRFToken', formData.get('csrfmiddlewaretoken'));  // Add CSRF token header
    
                xhr.onload = function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        // Parse the JSON response
                        var response = JSON.parse(xhr.responseText);
                        var clientNameSpan = document.getElementById('clientName-' + clientId);
                        var clientFormDiv = document.getElementById('form-' + clientId);
    
                        // Update the client name display
                        clientNameSpan.textContent = response.updatedName;
    
                        // Hide the form
                        clientFormDiv.style.display = 'none';
    
                    } else {
                        alert('Error updating client name.');
                    }
                };
    
                xhr.onerror = function() {
                    alert('Error connecting to server.');
                };
    
                xhr.send(formData);  // Send the form data
            });
        });
    });
        
</script>
{% endblock %}
