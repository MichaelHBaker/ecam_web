{% extends 'base.html' %}

{% block title %}ECAM Web{% endblock %}

{% block extra_css %}
<style>
    .w3-dropdown-content {
        transform: translateX(-10%);
    }

    .tree-headings {
        padding-left: 35px;
    }
    .tree-heading-before {
        padding-left: 6px;
    }

    .caret::before {
        content: "\25B6";
        display: inline-block;
        margin-right: 6px;
    }

    .caret-down::before {
        transform: rotate(90deg);
    }

    .tree-item {
        display: flex; /* Align children in a row */
        align-items: center; /* Vertically center align */
        padding: 4px 0; /* Add some spacing */
    }

    .tree-item .tree-text {
        flex-grow: 1; /* Allow text to grow as needed */
    }

    .tree-item .item-actions {
        display: none; /* Hide by default */
        margin-left: 20px; /* Position 20px from the text */
        z-index: 1;
    }

    /* Show the three dots on hover */
    .tree-item:hover .item-actions {
        display: inline-block;
    }

    /* Dropdown appears when hovering on the three dots */
    .item-actions:hover .w3-dropdown-content {
        display: block;
    }

    /* Hover effect for tree items */
    .tree-item:hover {
        background-color: #f1f1f1;
    }

    .w3-container-tree {
        width: fit-content !important; /* Override the width */
    }

    /* Scoped to section buttons in the dashboard */
    .w3-bar-item.w3-button.section-button {
        width: 200px; /* Set a fixed width for section buttons */
        text-align: left; /* Align text to the left */
        padding-left: 16px; /* Optional padding */

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
            
    }
    
</style>
{% endblock %}

{% block content %}

<!-- Location Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('id_location')" class="w3-bar-item w3-button section-button">
        <i id="id_chevronIcon-id_location" class="bi bi-chevron-right"></i> Location
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'location' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportlocation()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="id_location" class="w3-container w3-container-tree w3-hide">
    <span class="tree-headings">
        Clients
        <i class="bi bi-chevron-right"></i><span class=tree-heading-before>Projects</span>
        <i class="bi bi-chevron-right"></i><span class=tree-heading-before>Locations</span>
        <i class="bi bi-chevron-right"></i><span class=tree-heading-before>Measurements</span>
    </span>

    {% for client in clients %}
    <div class="tree-item w3-hover-light-grey">


        <div id="id_form-{{ client.id }}" class="tree-text">
            <form id="id_clientForm-{{ client.id }}" onsubmit="return updateClient(event, '{{ client.id }}')">
                {% csrf_token %}
                <input type="hidden" name="client_id" value="{{ client.id }}">
                <button type="button" onclick="toggleOpenClose('id_{{ client.name|slugify }}-{{ client.id }}')" class="w3-button" title="Email: {{ client.contact_email }}, Phone: {{ client.phone_number}}">
                    <i id="id_chevronIcon-id_{{ client.name|slugify }}-{{ client.id }}" class="bi bi-chevron-right"></i>
                    <span 
                        id="clientName-{{ client.id }}"
                        contenteditable="false"
                        onclick="event.stopPropagation()"
                    >{{ client.name }}</span>
                </button>

    {% comment %} next step is to add the other fields to the line for editing, use blur for update? {% endcomment %}

                <span id="editControls-{{ client.id }}" style="display:none; margin-left: 4px;">
                    <button type="submit" class="w3-button w3-tiny w3-padding-small" onclick="event.stopPropagation()">
                        <i class="bi bi-check w3-xlarge"></i>
                    </button>
                    <button type="button" class="w3-button w3-tiny w3-padding-small" onclick="cancelEdit(event, '{{ client.id }}')">
                        <i class="bi bi-x w3-xlarge" ></i>
                    </button>
                </span>
            </form>
        </div>

        <div class="item-actions">
            <button class="w3-button">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <div class="w3-dropdown-content w3-bar-block w3-border">
                <a href="#" class="w3-bar-item w3-button"><i class="bi bi-plus"></i> Add Client</a>
                <a href="#" onclick="editClient('{{ client.id }}'); return false;" class="w3-bar-item w3-button">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <a href="#" class="w3-bar-item w3-button"><i class="bi bi-trash"></i> Delete</a>
            </div>
        </div>
    </div>

    <div id="id_{{ client.name|slugify }}-{{ client.id }}" class="w3-container w3-hide w3-margin-left">
        {% for project in client.projects.all %}
        
        <div class="tree-item w3-hover-light-grey">
            <div class="tree-text">
                <button onclick="toggleOpenClose('{{ project.name }}-{{ project.id }}')" class="w3-button">
                    <i id="chevronIcon-{{ project.name }}-{{ project.id }}" class="bi bi-chevron-right"></i> {{ project.name }} ({{ project.get_project_type_display }})
                </button>
            </div>
            <div class="item-actions">
                <button class="w3-button">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <div class="w3-dropdown-content w3-bar-block w3-border">
                    <a href="#" class="w3-bar-item w3-button"><i class="bi bi-plus"></i> Add Project</a>
                    <a href="#" class="w3-bar-item w3-button"><i class="bi bi-pencil"></i> Edit</a>
                    <a href="#" class="w3-bar-item w3-button"><i class="bi bi-trash"></i> Delete</a>
                </div>
            </div>
        </div>
        
        <div id="{{ project.name }}-{{ project.id }}" class="w3-container w3-hide w3-margin-left">
            {% for location in project.locations.all %}
            <div class="tree-item w3-hover-light-grey">
                <div class="tree-text">
                    <button onclick="toggleOpenClose('{{ location.name }}-{{ location.id }}')" class="w3-button">
                        <i id="chevronIcon-{{ location.name }}-{{ location.id }}" class="bi bi-chevron-right"></i> {{ location.name }}
                    </button>
                </div>
                <div class="item-actions">
                    <button class="w3-button">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="w3-dropdown-content w3-bar-block w3-border">
                        <a href="#" class="w3-bar-item w3-button"><i class="bi bi-plus"></i> Add Location</a>
                        <a href="#" class="w3-bar-item w3-button"><i class="bi bi-pencil"></i> Edit</a>
                        <a href="#" class="w3-bar-item w3-button"><i class="bi bi-trash"></i> Delete</a>
                    </div>
                </div>
            </div>

            <div id="{{ location.name }}-{{ location.id }}" class="w3-container w3-hide w3-margin-left">
                {% for measurement in location.measurements.all %}
                <div class="tree-item w3-hover-light-grey">
                    <div class="tree-text">
                        <button class="w3-button">
                            {{ measurement.name }}
                        </button>
                    </div>
                    <div class="item-actions">
                        <button class="w3-button">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <div class="w3-dropdown-content w3-bar-block w3-border">
                            <a href="#" class="w3-bar-item w3-button"><i class="bi bi-plus"></i> Add Measurement</a>
                            <a href="#" class="w3-bar-item w3-button"><i class="bi bi-pencil"></i> Edit</a>
                            <a href="#" class="w3-bar-item w3-button"><i class="bi bi-trash"></i> Delete</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>


<!-- Measurement Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('measurement')" class="w3-bar-item w3-button section-button">
        <i id="chevronIcon-measurement" class="bi bi-chevron-right"></i> Measurement
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'measurement' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportmeasurement()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="measurement" class="w3-container w3-hide">
    <p>Content about Measurement.</p>
</div>

<!-- Data Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('data')" class="w3-bar-item w3-button section-button">
        <i id="chevronIcon-data" class="bi bi-chevron-right"></i> Data
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'data' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportdata()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="data" class="w3-container w3-hide">
    <p>Content about Data.</p>
</div>

<!-- Dictionary Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('dictionary')" class="w3-bar-item w3-button section-button">
        <i id="chevronIcon-dictionary" class="bi bi-chevron-right"></i> Dictionary
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'dictionary' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportdictionary()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="dictionary" class="w3-container w3-hide">
    <p>Content about Dictionary.</p>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function toggleOpenClose(id) {
        var div = document.getElementById(id);
        var icon = document.getElementById('id_chevronIcon-' + id);
        if (div.classList.contains('w3-show')) {
            div.classList.remove('w3-show');
            div.classList.add('w3-hide');
            icon.className = "bi bi-chevron-right";
        } else {
            div.classList.remove('w3-hide');
            div.classList.add('w3-show');
            icon.className = "bi bi-chevron-down";
        }
    }

    const CSRF_TOKEN = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const apiFetch = async (endpoint, options = {}) => {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            credentials: 'same-origin'
        };
        
        const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
        const apiEndpoint = `/api${cleanEndpoint}`;
        
        const response = await fetch(apiEndpoint, {
            ...defaultOptions,
            ...options,
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `API Error: ${response.statusText}`);
        }
        
        return response.json();
    };
    
    function editClient(clientId) {
        const nameSpan = document.getElementById(`clientName-${clientId}`);
        const editControls = document.getElementById(`editControls-${clientId}`);
        
        // Store original name for cancel functionality
        nameSpan.dataset.originalName = nameSpan.textContent;
        
        // Enable editing and show controls
        nameSpan.contentEditable = "true";
        editControls.style.display = 'inline-block';
        
        // Focus and move cursor to end
        nameSpan.focus();
        const range = document.createRange();
        const selection = window.getSelection();
        range.selectNodeContents(nameSpan);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
        
        return false;
    }
    
    function cancelEdit(event, clientId) {
        event.stopPropagation();
        const nameSpan = document.getElementById(`clientName-${clientId}`);
        const editControls = document.getElementById(`editControls-${clientId}`);
        
        // Restore original name and disable editing
        nameSpan.contentEditable = "false";
        nameSpan.textContent = nameSpan.dataset.originalName;
        
        // Hide edit controls
        editControls.style.display = 'none';
        nameSpan.blur();
    }
    
    async function updateClient(event, clientId) {
        event.preventDefault();
        event.stopPropagation();
        
        const nameSpan = document.getElementById(`clientName-${clientId}`);
        const editControls = document.getElementById(`editControls-${clientId}`);
        const newName = nameSpan.textContent.trim();
        
        try {
            const response = await apiFetch(`clients/${clientId}/`, {
                method: 'PATCH',
                body: JSON.stringify({
                    name: newName
                })
            });
            
            // Update UI with response data
            nameSpan.textContent = response.name;
            nameSpan.contentEditable = "false";
            editControls.style.display = 'none';
            
        } catch (error) {
            console.error('Error updating client:', error);
            alert('Error updating client name: ' + error.message);
            cancelEdit(event, clientId);
        }
        
        return false;
    }
    
    function deleteClient(clientId) {
        if (!confirm('Are you sure you want to delete this client?')) {
            return;
        }
        
        try {
            apiFetch(`clients/${clientId}/`, {
                method: 'DELETE'
            }).then(() => {
                // Remove client element from DOM
                const clientElement = document.querySelector(`#form-${clientId}`).closest('.tree-item');
                const clientContainer = document.getElementById(`${clientElement.textContent.trim()}-${clientId}`);
                
                clientElement.remove();
                if (clientContainer) {
                    clientContainer.remove();
                }
            });
            
        } catch (error) {
            console.error('Error deleting client:', error);
            alert('Error deleting client. Please try again.');
        }
    }
    
    function addClient() {
        const newClientName = prompt('Enter new client name:');
        
        if (!newClientName) return;
        
        try {
            apiFetch('clients/', {
                method: 'POST',
                body: JSON.stringify({
                    name: newClientName,
                    contact_email: '',
                    phone_number: ''
                })
            }).then(() => {
                // Reload the page to show new client
                window.location.reload();
            });
            
        } catch (error) {
            console.error('Error adding client:', error);
            alert('Error adding client. Please try again.');
        }
    }
    

              
</script>
{% endblock %}
