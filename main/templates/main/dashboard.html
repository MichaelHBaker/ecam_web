{% extends 'base.html' %}
{% load static %}

{% block title %}Login{% endblock %}

{% block content %}
<!-- Main Content -->
<main class="w3-container" style="margin-top: 80px;">

    <!-- Projects Section -->
    <div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
        <div class="w3-bar-item" style="padding-right: 0">
            <button class="w3-button section-button" data-action="toggle-section">
                <i class="bi bi-chevron-right"></i> Projects
            </button>
        </div>
        <!-- Changed the structure here -->
        <div class="w3-dropdown-hover" style="margin-left: 0">
            <button class="w3-button">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4" style="min-width:150px">
                <a href="#" class="w3-bar-item w3-button" data-action="filter-projects">
                    <i class="bi bi-funnel"></i> Filter Projects
                </a>
                <a href="#" class="w3-bar-item w3-button" data-action="add-project">
                    <i class="bi bi-plus-lg"></i> Add Project
                </a>
            </div>
        </div>
    </div>    
    <div class="tree-container">
        <div class="tree-wrapper w3-margin-top">
            <!-- Projects will be loaded here dynamically -->
        </div>
        <div class="tree-loading w3-center w3-padding-16 w3-hide">
            <i class="bi bi-arrow-repeat w3-spin"></i> Loading projects...
        </div>
        <div class="no-results w3-panel w3-pale-yellow w3-hide">
            <p>No projects found. Create a new project to get started.</p>
        </div>
    </div>

    <!-- Measurements Section -->
    <div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
        <button class="w3-bar-item w3-button section-button" data-action="toggle-section">
            <i class="bi bi-chevron-right"></i> Measurements
        </button>
    </div>
    <div class="w3-container w3-hide">
        Measurements content
    </div>

    <!-- Data Section -->
    <div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
        <button class="w3-bar-item w3-button section-button" data-action="toggle-section">
            <i class="bi bi-chevron-right"></i> Data
        </button>
    </div>
    <div class="w3-container w3-hide">
        Data content
    </div>

    <!-- Models Section -->
    <div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
        <button class="w3-bar-item w3-button section-button" data-action="toggle-section">
            <i class="bi bi-chevron-right"></i> Models
        </button>
    </div>
    <div class="w3-container w3-hide">
        Models content
    </div>
</main>

{% endblock %}

{% block extra_js %}

<script type="module">
    import { 
        DOM, 
        NotificationUI,
        Events,
        TreeUI,
        Dashboard
    } from '/static/main/js/main.js';

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Initialize DOM first
            DOM.initialize();
            
            // Add section toggle handler
            Events.addDelegate(document, 'click', '[data-action="toggle-section"]', async (e, target) => {
                try {
                    const contentDiv = target.closest('.w3-bar').nextElementSibling;
                    const icon = target.querySelector('.bi');
                    const isExpanding = contentDiv.classList.contains('w3-hide');
                    
                    // Toggle section visibility
                    if (isExpanding) {
                        contentDiv.classList.remove('w3-hide');
                        icon.classList.remove('bi-chevron-right');
                        icon.classList.add('bi-chevron-down');
                        
                        // Handle section-specific initialization
                        const sectionText = target.textContent.trim();
                        if (sectionText.includes('Projects')) {
                            // Show a status message during loading
                            const statusId = 'loading-projects';
                            try {
                                NotificationUI.show({
                                    message: 'Loading projects...',
                                    type: 'info',
                                    duration: 2000
                                });
                                await Dashboard.initializeTree();
                            } catch (err) {
                                NotificationUI.show({
                                    message: `Failed to load projects: ${err.message}`,
                                    type: 'error',
                                    duration: 5000
                                });
                                throw err;
                            }
                        } else if (sectionText.includes('Measurements')) {
                            // Add measurements section initialization here
                            // For now, we'll just show placeholder content
                            contentDiv.innerHTML = contentDiv.innerHTML.trim() === 'Measurements content' ?
                                '<div class="w3-panel w3-pale-blue"><p>Measurement data will appear here</p></div>' :
                                contentDiv.innerHTML;
                        } else if (sectionText.includes('Data')) {
                            // Add data section initialization here
                            contentDiv.innerHTML = contentDiv.innerHTML.trim() === 'Data content' ?
                                '<div class="w3-panel w3-pale-blue"><p>Data management tools will appear here</p></div>' :
                                contentDiv.innerHTML;
                        } else if (sectionText.includes('Models')) {
                            // Add models section initialization here
                            contentDiv.innerHTML = contentDiv.innerHTML.trim() === 'Models content' ?
                                '<div class="w3-panel w3-pale-blue"><p>Models will be displayed here</p></div>' :
                                contentDiv.innerHTML;
                        }
                    } else {
                        // Collapse section
                        contentDiv.classList.add('w3-hide');
                        icon.classList.remove('bi-chevron-down');
                        icon.classList.add('bi-chevron-right');
                    }
                } catch (error) {
                    console.error('Error in section toggle:', error);
                    NotificationUI.show({
                        message: `Error toggling section: ${error.message}`,
                        type: 'error',
                        duration: 5000
                    });
                }
            });

            Events.addDelegate(document, 'click', '[data-action="filter-projects"]', (e, target) => {
                e.preventDefault();
                const filterInput = DOM.getElement('[data-action="filter-projects"]');
                if (filterInput) {
                    filterInput.focus();
                }
            });
            
            Events.addDelegate(document, 'click', '[data-action="add-project"]', (e, target) => {
                e.preventDefault();
                const addButton = DOM.getElement('#addProjectBtn');
                if (addButton) {
                    addButton.click();
                }
            });

        } catch (error) {
            console.error('Error initializing dashboard:', error);
            NotificationUI.show({
                message: `Dashboard initialization error: ${error.message}`,
                type: 'error',
                duration: 0, // Show until dismissed
                closeable: true
            });
        }
    });
</script>
{% endblock %}
