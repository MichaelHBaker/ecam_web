{% extends "main/base.html" %}
{% load static %}

{% block content %}
<div class="dashboard-container">
    <!-- Action Menu -->
    <div class="action-menu w3-bar w3-padding">
        <div class="w3-bar-item">
            <input type="text" 
                   class="w3-input w3-border" 
                   placeholder="Filter projects..."
                   data-action="filter-projects">
        </div>
        <button class="w3-bar-item w3-button" data-action="clear-filter">
            <i class="bi bi-x-circle"></i> Clear
        </button>
        <button class="w3-bar-item w3-button w3-right" data-action="add-project">
            <i class="bi bi-plus-circle"></i> New Project
        </button>
    </div>

    <!-- Main Tree Container -->
    <div id="tree-container" class="tree-container">
        <!-- Loading State -->
        <div class="loading-state w3-hide">
            <i class="bi bi-arrow-repeat spin"></i> Loading...
        </div>

        <!-- Error State -->
        <div class="error-state w3-hide">
            <div class="error-message"></div>
            <button class="w3-button w3-red" data-action="retry">Retry</button>
        </div>

        <!-- No Results State -->
        <div class="no-results w3-hide">
            <p>No projects found matching your filter.</p>
        </div>

        <!-- Tree Content -->
        <div class="tree-wrapper"></div>
    </div>

    <!-- Project Form Modal -->
    <div id="project-modal" class="w3-modal">
        <div class="w3-modal-content w3-card-4">
            <header class="w3-container w3-theme">
                <span class="w3-button w3-display-topright" data-action="close-modal">&times;</span>
                <h2 id="modal-title">New Project</h2>
            </header>
            <form id="project-form" class="w3-container w3-padding">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="name" class="w3-input w3-border" required>
                </div>
                <div class="form-group">
                    <label>Project Type</label>
                    <select name="project_type" class="w3-select w3-border" required>
                        <option value="">Select a type...</option>
                        {% for value, label in model_fields.project.fields.project_type.choices %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" name="start_date" class="w3-input w3-border">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" name="end_date" class="w3-input w3-border">
                </div>
                <div class="w3-padding-16">
                    <button type="submit" class="w3-button w3-theme">Save</button>
                    <button type="button" class="w3-button w3-gray" data-action="close-modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'main/css/components/tree.css' %}">
<link rel="stylesheet" href="{% static 'main/css/components/filters.css' %}">
{% endblock %}

{% block extra_js %}
<script type="module">
    import { TreeManager } from '{% static "main/js/tree.js" %}';
    import { DOM } from '{% static "main/js/dom.js" %}';
    import { API } from '{% static "main/js/api.js" %}';
    import { NotificationUI } from '{% static "main/js/ui.js" %}';

    // Initialize tree manager
    const treeManager = new TreeManager();
    await treeManager.initialize('tree-container');

    // Handle project form submission
    const projectForm = document.getElementById('project-form');
    projectForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        try {
            const formData = new FormData(projectForm);
            const response = await API.post('/api/projects/', Object.fromEntries(formData));
            
            // Close modal and refresh tree
            DOM.getElement('#project-modal').style.display = 'none';
            await treeManager.loadInitialState();
            
            NotificationUI.show({
                message: 'Project created successfully',
                type: 'success'
            });
            
        } catch (error) {
            NotificationUI.show({
                message: `Error creating project: ${error.message}`,
                type: 'error'
            });
        }
    });

    // Handle modal actions
    DOM.addDelegate(document, 'click', '[data-action="add-project"]', () => {
        projectForm.reset();
        DOM.getElement('#modal-title').textContent = 'New Project';
        DOM.getElement('#project-modal').style.display = 'block';
    });

    DOM.addDelegate(document, 'click', '[data-action="close-modal"]', () => {
        DOM.getElement('#project-modal').style.display = 'none';
    });
</script>
{% endblock %}