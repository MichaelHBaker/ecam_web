{% extends 'base.html' %}
{% load custom_tags %}
{% load static %}

{% block title %}ECAM Web{% endblock %}

{% block extra_css %}
<style>
    /* Tree structure and dropdowns */
    .w3-dropdown-content {
        transform: translateX(-10%);
    }

    .tree-headings {
        padding-left: 35px;
    }
    
    .tree-heading-before {
        padding-left: 6px;
    }

    .caret::before {
        content: "\25B6";
        display: inline-block;
        margin-right: 6px;
    }

    .caret-down::before {
        transform: rotate(90deg);
    }

    .tree-item {
        display: flex;
        align-items: center;
        padding: 4px 0;
    }

    .tree-item .tree-text {
        flex-grow: 1;
    }

    .tree-item .item-actions {
        display: none;
        margin-left: 20px;
        z-index: 1;
    }

    .tree-item:hover .item-actions {
        display: inline-block;
    }

    .item-actions:hover .w3-dropdown-content {
        display: block;
    }

    /* Measurement specific styles */
    .measurement-fields {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        flex-wrap: wrap;
    }

    .unit-select,
    .multiplier-select,
    .timezone-select {
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .unit-select { min-width: 120px; }
    .multiplier-select { width: 100px; }
    .timezone-select { width: 160px; }

    .w3-container-tree {
        width: fit-content !important;
    }

    .fields-container {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .tree-item-name, 
    .tree-item-field {
        border: none;
        background: transparent;
        padding: 4px 8px;
        font-size: 1rem;
        color: inherit;
        width: auto;
    }
    
    .tree-item-name.editing,
    .tree-item-field.editing {
        border: 1px solid #ccc;
        background-color: white;
        padding: 4px;
       
    }

    /* Dropdown positioning */
    .w3-dropdown-hover {
        position: relative;
        display: inline-block;
    }
    
    .w3-dropdown-content {
        display: none;
        position: absolute;
        background-color: #fff;
        min-width: 250px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    
    /* Show dropdown on hover */
    .w3-dropdown-hover:hover .w3-dropdown-content {
        display: block;
    }
    
    /* Dropdown items */
    .w3-dropdown-content .w3-bar-item {
        width: 100%;
        text-align: left;
        padding: 8px 16px;
    }
    
    .w3-dropdown-content .w3-bar-item i {
        margin-right: 8px;
    }
    
    /* Ensure dropdowns appear above other content */
    .w3-modal {
        z-index: 1000;
    }
    
    .w3-dropdown-content {
        z-index: 1001;
    }

    /* CodeMirror Gutter Customization */
    .CodeMirror-gutters {
        border-right: 1px solid #ddd;
        z-index: 5;
        display: flex;  /* Added */
    }
    
    .CodeMirror-linenumbers {
        border-right: 1px solid #eee;  /* Added separator */
    }
    
    .CodeMirror-gutter {
        min-width: 35px;  /* Base width for gutters */
    }
    
    .CodeMirror-linenumber {
        color: #999;
        padding: 0 3px 0 5px;
        cursor: default;  /* Changed */
    }
    
    .CodeMirror-linedata {
        color: #2196F3;
        text-align: right;
        font-size: 12px;
        padding: 0 5px;
        cursor: pointer;
    }

    /* Line Type Menu Styling */
    .line-type-menu {
        position: fixed;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1100;
        min-width: 150px;
        font-size: 13px;
    }
    
    .line-type-menu .w3-bar-block {
        padding: 4px 0;
    }
    
    .line-type-menu .w3-bar-item {
        padding: 8px 16px;
        transition: background-color 0.2s;
    }
    
    .line-type-menu .w3-bar-item i {
        margin-right: 8px;
        width: 16px;
        text-align: center;
    }
    
    .line-type-menu .w3-bar-item:hover {
        background-color: #f5f5f5;
    }
    
    .line-type-menu .w3-border-top {
        border-top: 1px solid #ddd;
        margin-top: 4px;
        padding-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Project Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('id_project')" class="w3-bar-item w3-button section-button">
        <i id="id_chevronIcon-id_project" class="bi bi-chevron-right"></i> Projects
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="#" 
               class="w3-bar-item w3-button" 
               onclick="if(document.getElementById('id_project').classList.contains('w3-hide')) 
                          toggleOpenClose('id_project'); 
                        crud.addItem('project', 
                          [{% for field in model_fields.project.fields %}
                            '{{ field.name }}'{% if not forloop.last %}, {% endif %}
                           {% endfor %}]); 
                        return false;">
                <i class="bi bi-plus"></i> Add Project
            </a>
            <a href="{% url 'project' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportproject()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>    
    </div>
</div>
<div id="id_project" class="w3-container w3-container-tree w3-hide">
    <span class="tree-headings">
        Project
        <i class="bi bi-chevron-right"></i><span class=tree-heading-before>Location</span>
        <i class="bi bi-chevron-right"></i><span class=tree-heading-before>Measurement</span>
    </span>

    {% for project in projects %}
        {% render_tree_item project 'project' model_fields %}
    {% endfor %}
</div>

<!-- Measurement Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('id_measurement')" class="w3-bar-item w3-button section-button">
        <i id="id_chevronIcon-id_measurement" class="bi bi-chevron-right"></i> Measurements
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'measurement' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportmeasurement()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="id_measurement" class="w3-container w3-hide">
    <p>Content about Measurement.</p>
</div>

<!-- Data Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('id_data')" class="w3-bar-item w3-button section-button">
        <i id="id_chevronIcon-id_data" class="bi bi-chevron-right"></i> Data
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'data' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportdata()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="id_data" class="w3-container w3-hide">
    <p>Content about Data.</p>
</div>

<!-- Models Section -->
<div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
    <button onclick="toggleOpenClose('id_model')" class="w3-bar-item w3-button section-button">
        <i id="id_chevronIcon-id_model" class="bi bi-chevron-right"></i> Models
    </button>
    <div class="w3-dropdown-hover">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            <a href="{% url 'model' %}" class="w3-bar-item w3-button">
                <i class="bi bi-box-arrow-up-right"></i> Full Page
            </a>
            <a href="#" onclick="exportmodel()" class="w3-bar-item w3-button">
                <i class="bi bi-file-earmark-arrow-down"></i> Export
            </a>
        </div>
    </div>
</div>
<div id="id_model" class="w3-container w3-hide">
    <p>Content about Models.</p>
</div>
{% endblock %}

{% block extra_js %}
<!-- Module JavaScript -->
<script type="module">
    import * as CRUD from "{% static 'main/js/crud.js' %}"; 
    window.crud = CRUD;

    // Initialize MODEL_FIELDS and measurement handlers
    CRUD.initializeModelFields().then(() => {
        document.querySelectorAll('.measurement-fields').forEach(field => {
            const type = field.closest('form').dataset.type;
            const id = field.closest('form').dataset.id;
            if (type && id) {
                CRUD.setupMeasurementHandlers(type, id);
            }
        });
    }).catch(error => {
        console.error('Failed to initialize MODEL_FIELDS:', error);
    });
</script>

<script>
    function toggleOpenClose(id) {
        var div = document.getElementById(id);
        var icon = document.getElementById('id_chevronIcon-' + id);
        if (div.classList.contains('w3-show')) {
            div.classList.remove('w3-show');
            div.classList.add('w3-hide');
            icon.className = "bi bi-chevron-right";
        } else {
            div.classList.remove('w3-hide');
            div.classList.add('w3-show');
            icon.className = "bi bi-chevron-down";
        }
    }
</script>
{% endblock %}