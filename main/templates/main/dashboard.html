{% extends 'base.html' %}
{% load static %}

{% block title %}Login{% endblock %}

{% block content %}
<!-- Main Content -->
<main class="w3-container" style="margin-top: 80px;">

    <!-- Projects Section -->
    <div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
        <button class="w3-bar-item w3-button section-button" data-action="toggle-section">
            <i class="bi bi-chevron-right"></i> Projects
        </button>
    </div>
    <div class="w3-container w3-hide">
        <div class="w3-row">
            <div class="w3-col m8 l9">
                <!-- Projects Tree Container -->
                <div class="tree-container">
                    <div class="w3-bar w3-light-grey">
                        <div class="w3-bar-item">
                            <input type="text" class="w3-input" placeholder="Filter projects..." 
                                data-action="filter-projects">
                        </div>
                        <div class="w3-bar-item w3-right">
                            <button class="w3-button w3-hover-light-grey" title="Add Project" id="addProjectBtn">
                                <i class="bi bi-plus-lg"></i> Add Project
                            </button>
                        </div>
                    </div>
                    <div class="tree-wrapper w3-margin-top">
                        <!-- Projects will be loaded here dynamically -->
                    </div>
                    <div class="tree-loading w3-center w3-padding-16 w3-hide">
                        <i class="bi bi-arrow-repeat w3-spin"></i> Loading projects...
                    </div>
                    <div class="no-results w3-panel w3-pale-yellow w3-hide">
                        <p>No projects found. Create a new project to get started.</p>
                    </div>
                </div>
            </div>
            <div class="w3-col m4 l3">
                <!-- Project Details Panel -->
                <div class="w3-card w3-white">
                    <div class="w3-container w3-blue">
                        <h4>Project Details</h4>
                    </div>
                    <div class="w3-container">
                        <div class="project-details-placeholder w3-padding-16 w3-center w3-text-grey">
                            <p><i class="bi bi-info-circle"></i> Select a project to view details</p>
                        </div>
                        <div class="project-details w3-hide">
                            <!-- Project details will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Measurements Section -->
    <div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
        <button class="w3-bar-item w3-button section-button" data-action="toggle-section">
            <i class="bi bi-chevron-right"></i> Measurements
        </button>
    </div>
    <div class="w3-container w3-hide">
        Measurements content
    </div>

    <!-- Data Section -->
    <div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
        <button class="w3-bar-item w3-button section-button" data-action="toggle-section">
            <i class="bi bi-chevron-right"></i> Data
        </button>
    </div>
    <div class="w3-container w3-hide">
        Data content
    </div>

    <!-- Models Section -->
    <div class="w3-bar w3-white w3-margin-bottom w3-bottombar">
        <button class="w3-bar-item w3-button section-button" data-action="toggle-section">
            <i class="bi bi-chevron-right"></i> Models
        </button>
    </div>
    <div class="w3-container w3-hide">
        Models content
    </div>
</main>

{% endblock %}

{% block extra_js %}

<script type="module">
    import { Dashboard } from '/static/main/js/main.js';
    import { DOM } from '/static/main/js/dom.js';
    import { NotificationUI } from '/static/main/js/ui.js';

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Initialize DOM first
            DOM.initialize();
            
            // Wait for Dashboard to initialize (if needed)
            // Note: main.js already calls Dashboard.initialize() on DOMContentLoaded
            
            // Add section toggle handler
            DOM.addDelegate(document, 'click', '[data-action="toggle-section"]', async (e, target) => {
                try {
                    const contentDiv = target.closest('.w3-bar').nextElementSibling;
                    const icon = target.querySelector('.bi');
                    const isExpanding = contentDiv.classList.contains('w3-hide');
                    
                    // Toggle section visibility
                    if (isExpanding) {
                        contentDiv.classList.remove('w3-hide');
                        icon.classList.remove('bi-chevron-right');
                        icon.classList.add('bi-chevron-down');
                        
                        // Handle section-specific initialization
                        const sectionText = target.textContent.trim();
                        if (sectionText.includes('Projects')) {
                            // Show a status message during loading
                            const statusId = 'loading-projects';
                            try {
                                NotificationUI.show({
                                    message: 'Loading projects...',
                                    type: 'info',
                                    duration: 2000
                                });
                                await Dashboard.initializeTree();
                            } catch (err) {
                                NotificationUI.show({
                                    message: `Failed to load projects: ${err.message}`,
                                    type: 'error',
                                    duration: 5000
                                });
                                throw err;
                            }
                        } else if (sectionText.includes('Measurements')) {
                            // Add measurements section initialization here
                            // For now, we'll just show placeholder content
                            contentDiv.innerHTML = contentDiv.innerHTML.trim() === 'Measurements content' ?
                                '<div class="w3-panel w3-pale-blue"><p>Measurement data will appear here</p></div>' :
                                contentDiv.innerHTML;
                        } else if (sectionText.includes('Data')) {
                            // Add data section initialization here
                            contentDiv.innerHTML = contentDiv.innerHTML.trim() === 'Data content' ?
                                '<div class="w3-panel w3-pale-blue"><p>Data management tools will appear here</p></div>' :
                                contentDiv.innerHTML;
                        } else if (sectionText.includes('Models')) {
                            // Add models section initialization here
                            contentDiv.innerHTML = contentDiv.innerHTML.trim() === 'Models content' ?
                                '<div class="w3-panel w3-pale-blue"><p>Models will be displayed here</p></div>' :
                                contentDiv.innerHTML;
                        }
                    } else {
                        // Collapse section
                        contentDiv.classList.add('w3-hide');
                        icon.classList.remove('bi-chevron-down');
                        icon.classList.add('bi-chevron-right');
                    }
                } catch (error) {
                    console.error('Error in section toggle:', error);
                    NotificationUI.show({
                        message: `Error toggling section: ${error.message}`,
                        type: 'error',
                        duration: 5000
                    });
                }
            });

            // Expand first section by default (optional)
            // setTimeout(() => {
            //     const firstSection = document.querySelector('[data-action="toggle-section"]');
            //     if (firstSection) firstSection.click();
            // }, 500);

        } catch (error) {
            console.error('Error initializing dashboard:', error);
            NotificationUI.show({
                message: `Dashboard initialization error: ${error.message}`,
                type: 'error',
                duration: 0, // Show until dismissed
                closeable: true
            });
        }
    });
</script>
{% endblock %}
