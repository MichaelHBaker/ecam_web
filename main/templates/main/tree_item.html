{% comment %}templates/main/tree_item.html{% endcomment %}

{% load custom_tags %}
<div class="tree-item w3-hover-light-grey">
    <!-- Main Tree Content -->
    <div id="id_form-{{ level_type }}-{{ item.id }}" class="tree-text">
        <form id="id_{{ level_type }}Form-{{ item.id }}" 
              onsubmit="return crud.updateItem(event, '{{ level_type }}', '{{ item.id }}', [{% for field in fields %}'{{ field.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}])">
            {% csrf_token %}
            <input type="hidden" name="{{ level_type }}_id" value="{{ item.id }}">
            {% if parent %}
                <input type="hidden" name="parent_id" value="{{ parent.id }}">
            {% endif %}

            <!-- Expand/Collapse Button -->
            {% if next_level_type %}
                <button type="button" 
                        onclick="toggleOpenClose('id_{{ level_type }}-{{ item.id }}')" 
                        class="w3-button"
                        title="Click to open/close {{ level_type }} details">
                    <i id="id_chevronIcon-id_{{ level_type }}-{{ item.id }}" 
                       class="bi bi-chevron-right"></i>
                </button>
            {% endif %}
            
            <!-- Fields Container -->
            <div class="fields-container">
                {% for field in fields %}
                    {% if field.name == 'name' %}
                        <!-- Always show name field -->
                        <input id="id_{{ level_type }}{{ field.name|capfirst|cut:" " }}-{{ item.id }}" 
                               type="text"
                               name="{{ field.name }}"
                               value="{{ item|get_attr:field.name|default:'' }}"
                               class="tree-item-field"
                               style="display: inline;"
                               title="{{ field.verbose_name }}"
                               readonly>
                    {% else %}
                        {% if field.is_foreign_key %}
                            <!-- Foreign Key Field -->
                            <select id="id_{{ level_type }}{{ field.name|capfirst|cut:" " }}-{{ item.id }}"
                                    name="{{ field.name }}"
                                    class="tree-item-field fk-select"
                                    style="display: none;">
                                <option value="">Select {{ field.name|title }}</option>
                                {% for choice in field.choices %}
                                    <option value="{{ choice.id }}" 
                                            {% if choice.id == item|get_attr:field.name|get_attr:'id' %}selected{% endif %}>
                                        {{ choice.display_name }}{% if choice.unit %} ({{ choice.unit }}){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        {% elif field.type == 'choice' %}
                            <!-- Choice Field -->
                            <select id="id_{{ level_type }}{{ field.name|capfirst|cut:" " }}-{{ item.id }}"
                                    name="{{ field.name }}"
                                    class="tree-item-field choice-select"
                                    style="display: none;"
                                    disabled>
                                <option value="">Select {{ field.name|title }}</option>
                                {% for choice in field.choices %}
                                    <option value="{{ choice.id }}" 
                                            {% if choice.id == item|get_attr:field.name %}selected{% endif %}>
                                        {{ choice.display_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <!-- Hidden Regular Field -->
                            <input id="id_{{ level_type }}{{ field.name|capfirst|cut:" " }}-{{ item.id }}" 
                                   type="text"
                                   name="{{ field.name }}"
                                   value="{{ item|get_attr:field.name|default:'' }}"
                                   class="tree-item-field"
                                   style="display: none;"
                                   title="{{ field.verbose_name }}"
                                   readonly>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Edit Controls -->
            <span id="id_{{ level_type }}EditControls-{{ item.id }}" style="display:none; margin-left: 4px;">
                <button type="submit" class="w3-button" style="padding: 0 4px;" onclick="event.stopPropagation()">
                    <i class="bi bi-check w3-large"></i>
                </button>
                <button type="button" class="w3-button" style="padding: 0 4px;" 
                        onclick="crud.cancelEdit(event, '{{ level_type }}', '{{ item.id }}', [{% for field in fields %}'{{ field.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}])">
                    <i class="bi bi-x w3-large"></i>
                </button>
            </span>
        </form>
    </div>

    <!-- Action Menu -->
    <div class="item-actions">
        <button class="w3-button">
            <i class="bi bi-three-dots-vertical"></i>
        </button>
        <div class="w3-dropdown-content w3-bar-block w3-border">
            {% if next_level_type %}
                <a href="#" class="w3-bar-item w3-button"
                   onclick="crud.addItem('{{ next_level_type }}', [{% for field in model_fields|get_item:next_level_type|get_item:'fields' %}'{{ field.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}], '{{ item.id }}'); return false;">
                    <i class="bi bi-plus"></i> Add {{ next_level_type|title }}
                </a>
            {% endif %}

            <a href="#" class="w3-bar-item w3-button"
               onclick="crud.editItem('{{ level_type }}', '{{ item.id }}', [{% for field in fields %}'{{ field.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}]); return false;">
                <i class="bi bi-pencil"></i> Edit
            </a>

            <a href="#" class="w3-bar-item w3-button"
               onclick="crud.deleteItem('{{ level_type }}', '{{ item.id }}'); return false;">
                <i class="bi bi-trash"></i> Delete
            </a>
        </div>
    </div>
</div>

{% if next_level_type and children_attr %}
    <div id="id_{{ level_type }}-{{ item.id }}" class="w3-container w3-hide w3-margin-left">
        {% for child in item|get_attr:children_attr %}
            {% render_tree_item child next_level_type model_fields item %}
        {% endfor %}
    </div>
{% endif %}